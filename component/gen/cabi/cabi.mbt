// Canonical ABI helpers - Generated by moon-component

///| Load byte from linear memory (i32.load8_u)
extern "wasm" fn mem_load8(ptr : Int) -> Int =
  #|(func (param i32) (result i32) (i32.load8_u (local.get 0)))

///| Store byte to linear memory (i32.store8)
extern "wasm" fn mem_store8(ptr : Int, val : Int) -> Unit =
  #|(func (param i32 i32) (result i32) (i32.store8 (local.get 0) (local.get 1)) (i32.const 0))

///| Load i32 from linear memory (i32.load)
extern "wasm" fn mem_load32(ptr : Int) -> Int =
  #|(func (param i32) (result i32) (i32.load (local.get 0)))

///| Store i32 to linear memory (i32.store)
extern "wasm" fn mem_store32(ptr : Int, val : Int) -> Unit =
  #|(func (param i32 i32) (result i32) (i32.store (local.get 0) (local.get 1)) (i32.const 0))

///| Load i64 from linear memory (i64.load)
extern "wasm" fn mem_load64(ptr : Int) -> Int64 =
  #|(func (param i32) (result i64) (i64.load (local.get 0)))

///| Store i64 to linear memory (i64.store)
extern "wasm" fn mem_store64(ptr : Int, val : Int64) -> Unit =
  #|(func (param i32 i64) (result i32) (i64.store (local.get 0) (local.get 1)) (i32.const 0))

///| Load f32 from linear memory (f32.load)
extern "wasm" fn mem_load_f32(ptr : Int) -> Float =
  #|(func (param i32) (result f32) (f32.load (local.get 0)))

///| Store f32 to linear memory (f32.store)
extern "wasm" fn mem_store_f32(ptr : Int, val : Float) -> Unit =
  #|(func (param i32 f32) (result i32) (f32.store (local.get 0) (local.get 1)) (i32.const 0))

///| Load f64 from linear memory (f64.load)
extern "wasm" fn mem_load_f64(ptr : Int) -> Double =
  #|(func (param i32) (result f64) (f64.load (local.get 0)))

///| Store f64 to linear memory (f64.store)
extern "wasm" fn mem_store_f64(ptr : Int, val : Double) -> Unit =
  #|(func (param i32 f64) (result i32) (f64.store (local.get 0) (local.get 1)) (i32.const 0))

///| Get current memory size in pages (memory.size)
extern "wasm" fn mem_size() -> Int =
  #|(func (result i32) (memory.size))

///| Grow memory by pages (memory.grow)
extern "wasm" fn mem_grow(pages : Int) -> Int =
  #|(func (param i32) (result i32) (memory.grow (local.get 0)))

///| Heap base address (skip first 64KB for safety)
let heap_base : Int = 65536

///| Get current heap offset
fn get_heap_offset() -> Int {
  mem_load32(0)
}

///| Set heap offset
fn set_heap_offset(offset : Int) -> Unit {
  mem_store32(0, offset)
}

///| Initialize heap if needed
fn ensure_heap_init() -> Unit {
  if get_heap_offset() == 0 {
    set_heap_offset(heap_base)
  }
}

///| Canonical ABI realloc function
///| Called by host to allocate memory for passing data
pub fn cabi_realloc(
  _old_ptr : Int,
  _old_size : Int,
  align : Int,
  new_size : Int,
) -> Int {
  ensure_heap_init()
  let offset = get_heap_offset()
  // Align offset
  let aligned = (offset + align - 1) & -(align)
  let new_offset = aligned + new_size
  // Grow memory if needed (64KB pages)
  let pages_needed = (new_offset + 65535) / 65536
  let current_pages = mem_size()
  if pages_needed > current_pages {
    let grow_result = mem_grow(pages_needed - current_pages)
    if grow_result == -1 {
      abort("cabi_realloc: memory grow failed")
    }
  }
  set_heap_offset(new_offset)
  aligned
}

///| Reset the allocator (useful between calls)
pub fn cabi_reset() -> Unit {
  set_heap_offset(heap_base)
}

///| Lift a string from linear memory
pub fn cabi_lift_string(ptr : Int, len : Int) -> String {
  let bytes : Array[Byte] = Array::new(capacity=len)
  for i in 0..<len {
    bytes.push(mem_load8(ptr + i).to_byte())
  }
  @utf8.decode_lossy(Bytes::from_array(bytes[:])[:])
}

///| Lower a string to linear memory, returns (ptr, len)
pub fn cabi_lower_string(s : String) -> (Int, Int) {
  let bytes = @utf8.encode(s)
  let len = bytes.length()
  let ptr = cabi_realloc(0, 0, 1, len)
  for i in 0..<len {
    mem_store8(ptr + i, bytes[i].to_int())
  }
  (ptr, len)
}

///| Read i32 from linear memory
pub fn cabi_read_i32(ptr : Int) -> Int {
  mem_load32(ptr)
}

///| Write i32 to linear memory
pub fn cabi_write_i32(ptr : Int, val : Int) -> Unit {
  mem_store32(ptr, val)
}

///| Read u8 from linear memory
pub fn cabi_read_u8(ptr : Int) -> Byte {
  mem_load8(ptr).to_byte()
}

///| Write u8 to linear memory
pub fn cabi_write_u8(ptr : Int, val : Byte) -> Unit {
  mem_store8(ptr, val.to_int())
}

///| Read i64 from linear memory
pub fn cabi_read_i64(ptr : Int) -> Int64 {
  mem_load64(ptr)
}

///| Write i64 to linear memory
pub fn cabi_write_i64(ptr : Int, val : Int64) -> Unit {
  mem_store64(ptr, val)
}

///| Read f32 from linear memory
pub fn cabi_read_f32(ptr : Int) -> Float {
  mem_load_f32(ptr)
}

///| Write f32 to linear memory
pub fn cabi_write_f32(ptr : Int, val : Float) -> Unit {
  mem_store_f32(ptr, val)
}

///| Read f64 from linear memory
pub fn cabi_read_f64(ptr : Int) -> Double {
  mem_load_f64(ptr)
}

///| Write f64 to linear memory
pub fn cabi_write_f64(ptr : Int, val : Double) -> Unit {
  mem_store_f64(ptr, val)
}

///| Read flags bitmask from linear memory
pub fn cabi_read_flags(ptr : Int) -> Int {
  mem_load32(ptr)
}

///| Write flags bitmask to linear memory
pub fn cabi_write_flags(ptr : Int, val : Int) -> Unit {
  mem_store32(ptr, val)
}
